<div class="content-panel" id="panel-permission-matrix">

    <style>
        /* 1. å¼·åŒ–å‡çµè¦–è¦ºï¼šåŠ å…¥ç´…è‰²é‚Šæ¡†ç·šèˆ‡æ–œç´‹èƒŒæ™¯ */
        .super-admin-row {
            background-color: rgba(255, 255, 255, 0.05) !important;
            /* ç¨å¾®æå‡äº®åº¦ */
            background-image: repeating-linear-gradient(45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 255, 255, 0.01) 10px,
                    rgba(255, 255, 255, 0.01) 20px) !important;
            /* è³ªæ„Ÿçš„å¾®æ–œç´‹ï¼Œä»£è¡¨é–å®šå€åŸŸ */
            border-left: 4px solid #dc3545 !important;
            /* å·¦å´ç´…è‰²ç‹€æ…‹æ¢ï¼Œå°æ‡‰æ¨™ç±¤é¡è‰² */
            pointer-events: none;
            /* å¾¹åº•ç¦ç”¨æ»‘é¼ äº’å‹• */
            position: relative;
        }

        /* è§£æ±ºè¡¨é ­å°é½Šå•é¡Œï¼šè®“è¡¨é ­ä¹Ÿé ç•™ 4px ç©ºé–“ */
        #panel-permission-matrix thead tr {
            border-left: 4px solid transparent !important;
        }

        .super-admin-row td {
            color: #888;
            /* æå‡ä¸€é»å°æ¯”åº¦ï¼Œè®“é–å®šçš„æ–‡å­—ä¾ç„¶æ¸…æ™°å¯è®€ */
            border-bottom: 1px solid rgba(220, 53, 69, 0.1) !important;
            /* åº•ç·šå¸¶ä¸€é»é»ç´… */
        }

        /* 2. è—æ–‡é¢¨æ ¼è³ªæ„Ÿé–‹é—œ (Switch) */
        .permission-switch {
            cursor: pointer;
            background-color: #222 !important;
            /* é»‘è‰²èƒŒæ™¯ */
            border: 1px solid #444 !important;
            /* å¸¶ä¸€é»é‡‘å±¬è³ªæ„Ÿçš„é‚Šæ¡† */
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) !important;
            /* å½ˆæ€§å‹•ç•« */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba(255,255,255,0.4)'/%3e%3c/svg%3e") !important;
        }

        /* é¸å–ç‹€æ…‹ï¼šå“ç‰Œç¿¡ç¿ ç¶  + å¾®ç™¼å…‰ */
        .permission-switch:checked {
            background-color: #2D5F4F !important;
            /* Momento å“ç‰Œç¶  */
            border-color: #3e7a67 !important;
            box-shadow: 0 0 10px rgba(45, 95, 79, 0.4) !important;
            /* ç¶ è‰²å¾®å…‰ */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e") !important;
        }

        /* é‡è¨­è¶…ç´šç®¡ç†å“¡è¡Œçš„é–‹é—œå¤–è§€ (é›–ç„¶è¢« disabled ä½†è¦å¥½çœ‹) */
        .super-admin-row .permission-switch {
            opacity: 0.8 !important;
            filter: brightness(0.7);
        }

        /* ç§»é™¤è—è‰²æ¡†æ¡† */
        .permission-switch:focus {
            box-shadow: none !important;
            outline: none !important;
        }

        /* æœå°‹æ¡†è³ªæ„Ÿèª¿æ•´ */
        #permissionSearchInput {
            border-radius: 20px;
            padding-left: 20px;
            background: #1a1a1a !important;
        }

        /* Pagination Styles */
        .pagination-custom {
            display: inline-flex;
            border: 1px solid #444;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
        }

        .pagination-custom button {
            background: #212529;
            color: #ccc;
            border: none;
            padding: 6px 12px;
            border-right: 1px solid #444;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .pagination-custom button:last-child {
            border-right: none;
        }

        .pagination-custom button:hover:not(:disabled) {
            background: #343a40;
            color: #fff;
        }

        .pagination-custom button.active {
            background: #0d6efd;
            color: white;
            cursor: default;
        }

        .pagination-custom button:disabled {
            color: #555;
            cursor: not-allowed;
        }
    </style>


    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>æ¬Šé™ç®¡ç†</h2>
        <div class="d-flex gap-2">
            <input type="text" id="permissionSearchInput" class="form-control bg-dark text-white border-secondary"
                placeholder="æœå°‹å§“åæˆ–è·ç¨±..." style="width: 250px;">
        </div>
    </div>

    <div class="card bg-dark border-secondary">
        <div class="table-responsive">
            <table class="table table-dark table-hover table-bordered align-middle mb-0">
                <thead class="bg-dark">
                    <tr class="border-secondary">
                        <th class="text-center" style="width: 80px;">ç·¨è™Ÿ</th>
                        <th>å§“å</th>
                        <th>è·ç¨±</th>
                        <th class="text-center">æœƒå“¡ç®¡ç†</th>
                        <th class="text-center">ä¸»è¾¦å¯©æ ¸</th>
                        <th class="text-center">å•†å“å¯©æ ¸</th>
                        <th class="text-center">æ´»å‹•å¯©æ ¸</th>
                        <th class="text-center">è¨‚å–®ç®¡ç†</th>
                        <th class="text-center">çµç®—ç®¡ç†</th>
                        <th class="text-center">å…¬å‘Šé€šçŸ¥</th>
                        <th class="text-center">ç•™è¨€æª¢èˆ‰</th>
                    </tr>
                </thead>
                <tbody id="permissionMatrixBody">
                    <tr th:each="emp : ${employees}" th:data-emp-id="${emp.empId}"
                        th:classappend="${emp.empId == 1} ? 'super-admin-row'">
                        <td class="text-center" th:text="${emp.empId}"></td>
                        <td th:text="${emp.empName}"></td>
                        <td>
                            <span th:if="${emp.empId == 1}" class="badge bg-danger">
                                <i class="fas fa-crown me-1"></i>è¶…ç´šç®¡ç†å“¡
                            </span>
                            <span th:unless="${emp.empId == 1}" th:text="${emp.jobTitle}"></span>
                        </td>
                        <td th:each="i : ${#numbers.sequence(1, 8)}" class="text-center">
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input permission-switch" type="checkbox" th:data-fid="${i}"
                                    th:disabled="${emp.empId == 1}" th:checked="${emp.hasFunction(i)}">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- åˆ†é æ§åˆ¶é …å®¹å™¨ (ç½®ä¸­) -->
    <div class="d-flex justify-content-center">
        <div id="permissionPagination" class="pagination-custom"></div>
    </div>

    <script th:inline="javascript">
        // ç¢ºä¿ jQuery è¼‰å…¥å¾Œå†åŸ·è¡Œ
        document.addEventListener("DOMContentLoaded", function () {
            bindPermissionEvents();
        });

        // å¦‚æœæ˜¯é€é AJAX ç‰‡æ®µè¼‰å…¥ï¼ŒDOMContentLoaded å¯èƒ½å·²ç¶“è§¸ç™¼éäº†ï¼Œç›´æ¥å˜—è©¦åŸ·è¡Œ
        if (typeof jQuery !== 'undefined') {
            bindPermissionEvents();
        }

        function bindPermissionEvents() {
            if (typeof $ === 'undefined') {
                console.warn('jQuery not found yet, retrying in 100ms...');
                setTimeout(bindPermissionEvents, 100);
                return;
            }

            // é˜²æ­¢é‡è¤‡ç¶å®š
            if ($('#permissionMatrixBody').data('bound')) return;
            $('#permissionMatrixBody').data('bound', true);

            // åˆ†é èˆ‡æœå°‹é‚è¼¯è¨­å®š ====================================
            const rowsPerPage = 10;
            const $tbody = $('#permissionMatrixBody');
            const $rows = $tbody.find('tr');
            const totalRows = $rows.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            let currentPage = 1;

            function showPage(page) {
                if (page < 1) page = 1;
                if (page > totalPages) page = totalPages;
                currentPage = page;

                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;

                $rows.hide();
                $rows.slice(start, end).show();

                renderButtons();
                $('#permissionPagination').show();
            }

            function renderButtons() {
                const $pagination = $('#permissionPagination');
                $pagination.empty();

                const $prevBtn = $('<button>ä¸Šä¸€é </button>').prop('disabled', currentPage === 1).click(() => showPage(currentPage - 1));
                $pagination.append($prevBtn);

                for (let i = 1; i <= totalPages; i++) {
                    const $btn = $('<button>' + i + '</button>').click(() => showPage(i));
                    if (i === currentPage) $btn.addClass('active');
                    $pagination.append($btn);
                }

                const $nextBtn = $('<button>ä¸‹ä¸€é </button>').prop('disabled', currentPage === totalPages).click(() => showPage(currentPage + 1));
                $pagination.append($nextBtn);
            }

            if (totalRows > rowsPerPage) {
                showPage(1);
            } else {
                $('#permissionPagination').hide();
                $rows.show();
            }
            // ======================================================

            // 2. ä¿®æ”¹æ¬Šé™äº‹ä»¶
            // (ç§»é™¤åŸæœ¬çš„ AJAX readAllï¼Œæ”¹ç”¨ Thymeleaf æ¸²æŸ“)

            // 2. ä¿®æ”¹æ¬Šé™äº‹ä»¶ (ä½¿ç”¨å§”æ´¾äº‹ä»¶ï¼Œå°å‹•æ…‹å…§å®¹æ›´å‹å–„)
            $(document).off('change', '.permission-switch').on('change', '.permission-switch', function () {
                const $sw = $(this);
                const eid = $sw.closest('tr').data('emp-id');
                const isChecked = $sw.is(':checked');

                const fids = [];
                $sw.closest('tr').find('.permission-switch:checked').each(function () {
                    fids.push($(this).data('fid'));
                });

                $.ajax({
                    url: '/admin/permissions/update',
                    method: 'POST',
                    contentType: 'application/json',
                    dataType: 'json',
                    data: JSON.stringify({ empId: eid, functionIds: fids }),
                    success: function (res) {
                        showMatrixAlert(isChecked ? 'ğŸ”‘ æ¬Šé™æˆæ¬ŠæˆåŠŸ' : 'ğŸ”’ æ¬Šé™å·²ç§»é™¤');
                    },
                    error: function (xhr, status, error) {
                        $sw.prop('checked', !isChecked); // æ¢å¾©ç‹€æ…‹
                        showMatrixAlert('âŒ å­˜æª”å¤±æ•—ï¼š' + (xhr.responseJSON?.message || 'æœªçŸ¥éŒ¯èª¤'));
                    }
                });
            });

            // 3. é—œéµå­—æœå°‹ (èˆ‡åˆ†é æ•´åˆ)
            $('#permissionSearchInput').off('input').on('input', function () {
                const val = $(this).val().toLowerCase();

                if (val === '') {
                    // æ¸…ç©ºæœå°‹ -> æ¢å¾©åˆ†é 
                    if (totalRows > rowsPerPage) {
                        showPage(1);
                        $('#permissionPagination').show();
                    } else {
                        $rows.show();
                        $('#permissionPagination').hide();
                    }
                } else {
                    // æœ‰æœå°‹ -> éš±è—åˆ†é ï¼Œé¡¯ç¤ºåŒ¹é…é …ç›®
                    $('#permissionPagination').hide();
                    $rows.each(function () {
                        const text = $(this).text().toLowerCase();
                        $(this).toggle(text.includes(val));
                    });
                }
            });
        }

        // è‡ªå®šç¾© Alert (å…¨åŸŸå¯ç”¨)
        window.showMatrixAlert = function (msg) {
            const existingAlert = document.getElementById('matrixCustomAlert');
            if (existingAlert) existingAlert.remove();

            var alertHtml =
                '<div id="matrixCustomAlert" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; ' +
                'background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; ' +
                'animation: matrixFadeIn 0.2s ease;">' +
                '<div style="background: #2b2b2b; padding: 40px 60px; border-radius: 12px; border: 1px solid #444; ' +
                'text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.6); animation: matrixScaleUp 0.2s ease;">' +
                '<h5 style="color: #fff; margin-bottom: 25px; letter-spacing: 1px; font-weight: 500;">' + msg + '</h5>' +
                '<button onclick="document.getElementById(\'matrixCustomAlert\').remove()" ' +
                'class="btn btn-primary px-5 py-2 fw-bold" style="border-radius: 6px;">ç¢ºå®š</button>' +
                '</div>' +
                '</div>' +
                '<style>' +
                '@keyframes matrixFadeIn { from { opacity: 0; } to { opacity: 1; } }' +
                '@keyframes matrixScaleUp { from { transform: scale(0.8); } to { transform: scale(1); } }' +
                '</style>';

            document.body.insertAdjacentHTML('beforeend', alertHtml);
        };
    </script>

</div>