<div class="content-panel" id="panel-notification-composer">
    <h2 class="mb-4">系統通知發送</h2>


    <form th:action="@{/notify/sendMessageNotify}" method="post" id="notifyForm">

        <input type="hidden" name="empId" value="1">

    <div class="row">
        <div class="col-lg-8">
            <div class="card bg-dark border-secondary">
                <div class="card-header border-secondary">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>編輯通知</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">通知類型</label>
                        <select name="type" class="form-select bg-dark text-white border-secondary">
                            <option>活動上架</option>
                            <option>商品上架</option>
                            <option>服務更新</option>
                            <option>系統公告</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label  class="form-label">通知標題</label>
                        <input id="notificationTitle" name="title" type="text" class="form-control bg-dark text-white border-secondary"
                            placeholder="輸入通知標題...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">通知內容</label>
                        <textarea id="notificationContent" name="rawContent" class="form-control bg-dark text-white border-secondary" rows="5"
                            placeholder="輸入通知內容..."></textarea>
                    </div>
<!--                    <div class="mb-3">-->
<!--                        <label class="form-label">連結 (選填)</label>-->
<!--                        <input name="url" type="text" class="form-control bg-dark text-white border-secondary"-->
<!--                            placeholder="https://...">-->
<!--                    </div>-->

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">發送時間</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sendTime" id="sendNow" checked>
                                <label class="form-check-label" for="sendNow">立即發送</label>
                            </div>
<!--                            <div class="form-check">-->
<!--                                <input class="form-check-input" type="radio" name="sendTime" id="sendLater">-->
<!--                                <label class="form-check-label" for="sendLater">排程發送</label>-->
<!--                            </div>-->
<!--                            <input type="datetime-local" class="form-control bg-dark text-white border-secondary mt-2"-->
<!--                                disabled id="scheduleTime">-->
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">推送通道</label>
                            <div class="form-check"><input class="form-check-input" type="radio" name="channel" value="web" checked>
                                <label class="form-check-label">站內通知</label>
                            </div>
<!--                            <div class="form-check"><input class="form-check-input" type="checkbox" name="channel" value="email"><label-->
<!--                                    class="form-check-label">Email</label></div>-->
<!--                            <div class="form-check"><input class="form-check-input" type="checkbox" name="channel" value="app"><label-->
<!--                                    class="form-check-label">推播 (App)</label>-->
<!--                            </div>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header border-secondary">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>收件對象</h5>
                </div>
                <div class="card-body">
                    <!-- 快速選擇 -->
                    <div class="mb-3">
                        <small class="text-muted text-uppercase mb-2 d-block">快速選擇</small>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="recipientGroup" value="all" id="recEveryone" checked>
                            <label class="form-check-label" for="recEveryone">
                                <i class="fas fa-globe me-1 text-primary"></i>所有人（會員+主辦方）
                                <span class="text-muted">(12,606)</span>
                            </label>
                        </div>
                    </div>

                    <hr class="border-secondary">

                    <!-- 前台會員 -->
                    <div class="mb-3">
                        <small class="text-muted text-uppercase mb-2 d-block">
                            <i class="fas fa-user me-1"></i>前台會員
                        </small>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="recipientGroup" value="front_all" id="recAllMembers">
                            <label class="form-check-label" for="recAllMembers">
                                全部會員 <span class="text-muted">(12,450)</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="recipientGroup" value="front_active" id="recActive">
                            <label class="form-check-label" for="recActive">
                                活躍會員 <span class="text-muted">(8,320)</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="recipientGroup" value="front_new" id="recNewMembers">
                            <label class="form-check-label" for="recNewMembers">
                                新會員（30天內註冊）<span class="text-muted">(523)</span>
                            </label>
                        </div>
                    </div>

                    <hr class="border-secondary">

                    <!-- 主辦方 -->
                    <div class="mb-3">
                        <small class="text-muted text-uppercase mb-2 d-block">
                            <i class="fas fa-store me-1"></i>主辦方
                        </small>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="recipientGroup" value="org_all" id="recAllOrganizers">
                            <label class="form-check-label" for="recAllOrganizers">
                                全部主辦方 <span class="text-muted">(156)</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="recipientGroup" value="org_active" id="recActiveOrganizers">
                            <label class="form-check-label" for="recActiveOrganizers">
                                活躍主辦方 <span class="text-muted">(89)</span>
                            </label>
                        </div>
                    </div>

                    <hr class="border-secondary">

                    <!-- 自訂 -->
<!--                    <div class="form-check mb-2">-->
<!--                        <input class="form-check-input" type="radio" name="recipientGroup" value="custom" id="recCustom">-->
<!--                        <label class="form-check-label" for="recCustom">-->
<!--                            <i class="fas fa-filter me-1"></i>自訂條件-->
<!--                        </label>-->
<!--                    </div>-->
<!--                    <div class="mt-3 d-none" id="customRecipients">-->
<!--                        <input type="text"  id="customRecipientsInput" class="form-control bg-dark text-white border-secondary mb-2"-->
<!--                            placeholder="搜尋會員或主辦方...">-->
<!--                        <small class="text-muted">可輸入 Email 或 ID，用逗號分隔</small>-->
<!--                    </div>-->
                </div>
            </div>

            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header border-secondary">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>範本</h5>
                </div>
                <div class="card-body">
                    <select id="templateSelect" class="form-select bg-dark text-white border-secondary mb-2">
                        <option value="" selected disabled>選擇範本...</option>
                        <option value="1" data-title="【新活動上架】Momento 精選推薦" data-content="親愛的會員您好，最新的藝文活動已經上架，快來看看新活動吧！">新活動上架通知</option>
                        <option value="2" data-title="【新商品上架】Momento 精選推薦" data-content="親愛的會員您好，最新的商品已經上架，快來查看吧！">新商品上架通知</option>
                        <option value="3" data-title="【重要】Momento 會員服務條款更新公告" data-content="我們近期更新了隱私權政策與服務條款，請點擊連結查看詳細修訂內容，以維護您的權益。">服務條款更新</option>
                        <option value="4" data-title="【公告】Momento 系統維護通知" data-content="我們將於本週凌晨進行系統升級，屆時將暫停服務。">系統維護公告</option>
                    </select>
<!--                    <button id="btnLoadTemplate" class="btn btn-sm btn-outline-secondary w-100">載入範本</button>-->
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg" >
                    <i class="fas fa-paper-plane me-2"></i>發送通知</button>
<!--                <button class="btn btn-outline-secondary">預覽</button>-->
            </div>
        </div>
    </div>
    </form>
    <!-- History -->
    <div class="card bg-dark border-secondary mt-4" id="historyTableContainer">
        <div class="card-header border-secondary d-flex justify-content-between">
            <h5 class="mb-0"><i class="fas fa-history me-2"></i>發送紀錄</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-dark mb-0">
                <thead class="border-secondary">
                    <tr>
                        <th>發送時間</th>
                        <th>標題</th>
                        <th>類型</th>
                        <th>對象</th>
                        <th>已讀率</th>
                        <th>狀態</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="row : ${messageNotifyRecords}">
                        <td th:text="${row[1] != null ? #dates.format(row[1], 'yyyy/MM/dd HH:mm') : ''}">2024/12/25 18:00</td>

                        <td th:text="${row[0]}">標題內容</td>

                        <td><span class="badge bg-info" th:text="${row[5]}">類型</span></td>

                        <td th:text="${row[2]}">對象</td>

                        <td>
                            <div class="progress" style="width: 100px; height: 6px;">
                                <div class="progress-bar bg-success"
                                     th:style="'width:' + (${row[4]} * 100 / ${row[3]}) + '%'"></div>
                            </div>
                            <small th:text="${#numbers.formatDecimal(row[4] * 100.0 / row[3], 1, 0)} + '%'"></small>
                        </td>

                        <td><span class="badge bg-success">已發送</span></td>
                    </tr>

                    <th:block th:if="${massNotifyRecords == null or #lists.isEmpty(massNotifyRecords)}">
                        <tr>
                            <td>2024/12/25 18:00</td>
                            <td>聖誕節快樂！限時優惠開跑</td>
                            <td><span class="badge bg-warning text-dark">促銷</span></td>
                            <td>全部會員</td>
                            <td>
                                <div class="progress" style="width: 100px; height: 6px;">
                                    <div class="progress-bar bg-success" style="width: 68%;"></div>
                                </div><small>68%</small>
                            </td>
                            <td><span class="badge bg-success">已發送</span></td>
                        </tr>
                        <tr>
                            <td>2024/12/20 10:00</td>
                            <td>系統維護公告 (12/21)</td>
                            <td><span class="badge bg-info">系統</span></td>
                            <td>全部會員</td>
                            <td>
                                <div class="progress" style="width: 100px; height: 6px;">
                                    <div class="progress-bar bg-success" style="width: 82%;"></div>
                                </div><small>82%</small>
                            </td>
                            <td><span class="badge bg-success">已發送</span></td>
                        </tr>
                    </th:block>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="javascript">
        $(document).ready(function (){
            // 範本
            $('#templateSelect').on('change', function() {
                const selected = $(this).find(':selected');
                const title = selected.data('title');
                const content = selected.data('content');

                if (title && content) {
                    $('#notificationTitle').val(title);
                    $('#notificationContent').val(content);
                }
            });

            // 發送同步紀錄
            $('#notifyForm').on('submit', function(e) {
                e.preventDefault(); // 阻止表單跳轉

                // 顯示Loading
                Swal.fire({
                    title: '正在發送通知...',
                    allowOutsideClick: false,
                    background: '#1a1d20',
                    color: '#fff',
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // 使用 AJAX 發送資料
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: $(this).serialize(), // 自動抓取標題、內容、對象等所有欄位
                    success: function(res) {
                        // 當後端回傳 ResponseEntity.ok() (200 OK) 時執行
                        Swal.fire({
                            icon: 'success',
                            title: '發送成功',
                            text: res.message, // 顯示後端傳回的"通知已成功發送！"
                            timer: 2000,
                            showConfirmButton: false,
                            background: '#1a1d20',
                            color: '#fff'
                        });

                        // 重新載入發送紀錄
                        $('#historyTableContainer').load(window.location.href + ' #historyTableContainer > *');

                        // 清空輸入框
                        $('input[name="title"]').val('');
                        $('textarea[name="rawContent"]').val('');
                    },
                    error: function(err) {
                        // 當後端回傳500(INTERNAL_SERVER_ERROR)時，跳進這裡
                        let errorMsg = "系統發生未知錯誤";
                        if (err.responseJSON && err.responseJSON.message) {
                            errorMsg = err.responseJSON.message; // 取得body(response)裡的錯誤訊息
                        }

                        Swal.fire({
                            icon: 'error',
                            title: '發送失敗',
                            text: errorMsg,
                            background: '#1a1d20',
                            color: '#fff'
                        });
                    }
                });
            });
        });
    </script>
</div>