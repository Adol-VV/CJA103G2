<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®ç¢ºèª - Momento</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom Theme -->
    <link href="../../css/momento-theme.css" rel="stylesheet">

    <style>
        .order-summary-card {
            position: sticky;
            top: 100px;
        }

        .ticket-item {
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
        }

        .ticket-item:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid px-lg-5">
            <a class="navbar-brand" href="../../index.html">Momento</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link active" href="event-list.html">æ‰¾æ´»å‹•</a></li>
                    <li class="nav-item"><a class="nav-link" href="prod-list.html">æ‰¾å•†å“</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">æ–‡ç« </a></li>
                    <li class="nav-item"><a class="nav-link" href="#">é—œæ–¼æˆ‘å€‘</a></li>
                </ul>
                <div class="d-flex align-items-center gap-3 ms-lg-3 mt-3 mt-lg-0">
                    <a href="#" class="position-relative text-white text-decoration-none">
                        <i class="fas fa-shopping-cart fa-lg"></i>
                    </a>
                    <a href="login.html" class="btn btn-primary btn-sm px-4">æœƒå“¡ç™»å…¥</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../../index.html" class="text-decoration-none text-muted">é¦–é </a>
                </li>
                <li class="breadcrumb-item"><a href="event-list.html" class="text-decoration-none text-muted">æ‰¾æ´»å‹•</a>
                </li>
                <li class="breadcrumb-item"><a href="#" class="text-decoration-none text-muted"
                        id="breadcrumbEvent">æ´»å‹•è©³æƒ…</a></li>
                <li class="breadcrumb-item active text-white" aria-current="page">è¨‚å–®ç¢ºèª</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Left: Order Form -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header border-secondary bg-transparent">
                        <h5 class="mb-0"><i class="fas fa-user-edit me-2"></i>è¨‚è³¼äººè³‡æ–™</h5>
                    </div>
                    <div class="card-body">
                        <form id="orderForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">å§“å <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="buyerName" required
                                        placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">æ‰‹æ©Ÿ <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" name="buyerPhone" required
                                        placeholder="0912345678" pattern="[0-9]{10}">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" name="buyerEmail" required
                                        placeholder="example@email.com">
                                    <small class="text-muted">é›»å­ç¥¨åˆ¸å°‡ç™¼é€è‡³æ­¤ä¿¡ç®±</small>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Token Discount -->
                <div class="card mb-4">
                    <div class="card-header border-secondary bg-transparent">
                        <h5 class="mb-0"><i class="fas fa-coins me-2 text-warning"></i>ä»£å¹£æŠ˜æŠµ</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info bg-dark border-info mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>å¯ç”¨ä»£å¹£ï¼š<strong id="availableTokens">0</strong> å…ƒ</span>
                                <button type="button" class="btn btn-sm btn-warning" id="btnUseTokens">
                                    <i class="fas fa-magic me-1"></i>ä¸€éµä½¿ç”¨
                                </button>
                            </div>
                        </div>

                        <div class="input-group">
                            <span class="input-group-text bg-dark border-secondary">
                                <i class="fas fa-coins text-warning"></i>
                            </span>
                            <input type="number" class="form-control" id="tokenAmount" placeholder="è¼¸å…¥ä½¿ç”¨ä»£å¹£æ•¸é‡" min="0"
                                value="0">
                            <span class="input-group-text bg-dark border-secondary">å…ƒ</span>
                        </div>

                        <div id="tokenMessage" class="mt-2 small text-muted"></div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="card mb-4">
                    <div class="card-header border-secondary bg-transparent">
                        <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>ä»˜æ¬¾æ–¹å¼</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-3 p-3 border border-secondary rounded">
                            <input class="form-check-input" type="radio" name="paymentMethod" value="ECPAY"
                                id="payECPay" checked>
                            <label class="form-check-label w-100" for="payECPay">
                                <div class="d-flex align-items-center">
                                    <i class="far fa-credit-card me-2 text-primary"></i>
                                    <div>
                                        <strong>ç¶ ç•Œç§‘æŠ€</strong>
                                        <p class="text-muted small mb-0">ä¿¡ç”¨å¡ / ATM / è¶…å•†ä»£ç¢¼</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <div class="form-check p-3 border border-secondary rounded">
                            <input class="form-check-input" type="radio" name="paymentMethod" value="LINEPAY"
                                id="payLINEPay">
                            <label class="form-check-label w-100" for="payLINEPay">
                                <div class="d-flex align-items-center">
                                    <i class="fab fa-line me-2 text-success"></i>
                                    <div>
                                        <strong>LINE Pay</strong>
                                        <p class="text-muted small mb-0">ä½¿ç”¨ LINE Pay å¿«é€Ÿä»˜æ¬¾</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Terms -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                            <label class="form-check-label" for="agreeTerms">
                                æˆ‘å·²é–±è®€ä¸¦åŒæ„ <a href="#" class="text-primary">æœå‹™æ¢æ¬¾</a> åŠ
                                <a href="#" class="text-primary">é€€ç¥¨æ”¿ç­–</a>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Order Summary -->
            <div class="col-lg-4">
                <div class="card order-summary-card">
                    <div class="card-header border-secondary bg-transparent">
                        <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>è¨‚å–®æ‘˜è¦</h5>
                    </div>
                    <div class="card-body">
                        <!-- Selected Tickets -->
                        <div id="selectedTickets" class="mb-3">
                            <!-- å‹•æ…‹è¼‰å…¥ç¥¨ç¨® -->
                        </div>

                        <hr class="border-secondary">

                        <!-- Price Summary -->
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">å°è¨ˆ</span>
                            <strong id="subtotal">NT$ 0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2" id="tokenDiscountRow"
                            style="display: none !important;">
                            <span class="text-success"><i class="fas fa-coins me-1"></i>ä»£å¹£æŠ˜æŠµ</span>
                            <strong class="text-success" id="tokenDiscount">- NT$ 0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">ç¸½è¨ˆ</span>
                            <strong class="text-success fs-4" id="totalAmount">NT$ 0</strong>
                        </div>

                        <!-- Submit Button -->
                        <button type="button" class="btn btn-primary w-100 btn-lg mb-2" id="btnSubmitOrder">
                            <i class="fas fa-check-circle me-2"></i>ç¢ºèªè¨‚å–®
                        </button>
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="history.back()">
                            <i class="fas fa-arrow-left me-2"></i>è¿”å›ä¿®æ”¹
                        </button>

                        <p class="text-center text-muted small mt-3 mb-0">
                            <i class="fas fa-shield-alt me-1"></i>
                            æ‚¨çš„ä»˜æ¬¾è³‡è¨Šå°‡å—åˆ°ä¿è­·
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Success Section (é è¨­éš±è—) -->
    <div class="container py-5" id="orderSuccessSection" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- æˆåŠŸè¨Šæ¯ -->
                <div class="card bg-dark border-secondary text-center mb-4">
                    <div class="card-body py-5">
                        <div class="success-animation mb-4">
                            <i class="fas fa-check-circle fa-5x text-success"></i>
                        </div>
                        <h2 class="mb-3">è³¼ç¥¨æˆåŠŸï¼</h2>
                        <p class="text-muted mb-4">æ„Ÿè¬æ‚¨çš„è³¼è²·ï¼Œè¨‚å–®ç¢ºèªä¿¡å·²å¯„é€è‡³æ‚¨çš„ä¿¡ç®±</p>

                        <div class="bg-black rounded p-4 mb-4 d-inline-block">
                            <div class="text-muted small mb-1">è¨‚å–®ç·¨è™Ÿ</div>
                            <div class="h4 text-success mb-0" id="successOrderNumber">MOM-20240120-001234</div>
                        </div>
                    </div>
                </div>

                <!-- QR Code é¡¯ç¤º -->
                <div class="card bg-dark border-secondary text-center mb-4">
                    <div class="card-header border-secondary bg-transparent">
                        <h5 class="mb-0"><i class="fas fa-qrcode me-2"></i>é›»å­ç¥¨åˆ¸</h5>
                    </div>
                    <div class="card-body py-4">
                        <p class="text-muted small mb-3">è«‹å‡ºç¤ºæ­¤ QR Code å…¥å ´</p>
                        <img id="qrCodeImage" src="" alt="QR Code" class="img-fluid" style="max-width: 300px;">
                        <p class="text-muted small mt-3 mb-0">
                            <i class="fas fa-info-circle me-1"></i>ç¥¨åˆ¸å·²åŒæ­¥å¯„é€è‡³æ‚¨çš„ä¿¡ç®±
                        </p>
                    </div>
                </div>

                <!-- ä»£å¹£å›é¥‹é€šçŸ¥ (æ»¿ 300 æ‰é¡¯ç¤º) -->
                <div id="tokenRewardNotice" class="alert alert-success bg-success bg-opacity-10 border-success mb-4"
                    style="display: none;">
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="fas fa-coins fa-2x text-success me-3"></i>
                        <div>
                            <h6 class="mb-0 text-success">
                                ğŸ‰ æ­å–œç²å¾— <strong id="tokenRewardAmount">5</strong> å…ƒä»£å¹£å›é¥‹ï¼
                            </h6>
                            <small class="text-muted">
                                ä»£å¹£å·²è‡ªå‹•å­˜å…¥æ‚¨çš„å¸³æˆ¶ï¼Œå¯æ–¼ä¸‹æ¬¡æ¶ˆè²»æŠ˜æŠµä½¿ç”¨
                            </small>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="d-flex justify-content-center gap-3">
                    <a href="/member/order/history" class="btn btn-primary">
                        <i class="fas fa-list me-2"></i>æŸ¥çœ‹æˆ‘çš„è¨‚å–®
                    </a>
                    <a href="/event/list" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>ç¹¼çºŒç€è¦½æ´»å‹•
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-top border-secondary mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Momento</h5>
                    <p class="text-muted small">æ‰“é€ æœ€æ£’çš„æ´»å‹•é«”é©—å¹³å°</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="text-muted small mb-0">&copy; 2024 Momento. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Order Page Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // å¾ sessionStorage è¼‰å…¥é¸æ“‡çš„ç¥¨ç¨®
            const selections = JSON.parse(sessionStorage.getItem('ticketSelections') || '[]');

            if (selections.length === 0) {
                alert('æœªé¸æ“‡ç¥¨ç¨®ï¼Œå°‡è¿”å›æ´»å‹•é é¢');
                history.back();
                return;
            }

            // é¡¯ç¤ºé¸æ“‡çš„ç¥¨ç¨®
            let ticketsHtml = '';
            let total = 0;

            selections.forEach(item => {
                const subtotal = parseInt(item.price) * parseInt(item.quantity);
                total += subtotal;

                ticketsHtml += `
                    <div class="ticket-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${item.ticketName}</strong>
                                <p class="text-muted small mb-0">NT$ ${parseInt(item.price).toLocaleString()} Ã— ${item.quantity}</p>
                            </div>
                            <strong class="text-success">NT$ ${subtotal.toLocaleString()}</strong>
                        </div>
                    </div>
                `;
            });

            document.getElementById('selectedTickets').innerHTML = ticketsHtml;
            document.getElementById('subtotal').textContent = 'NT$ ' + total.toLocaleString();
            document.getElementById('totalAmount').textContent = 'NT$ ' + total.toLocaleString();

            // === ä»£å¹£æŠ˜æŠµåŠŸèƒ½ ===
            const availableTokens = 150; // TODO: å¾å¾Œç«¯å–å¾—æœƒå“¡å¯ç”¨ä»£å¹£
            document.getElementById('availableTokens').textContent = availableTokens;

            let currentTokenDiscount = 0;
            let orderSubtotal = total;

            // è¨ˆç®—æ‡‰ä»˜é‡‘é¡
            function calculateTotal() {
                const finalAmount = Math.max(0, orderSubtotal - currentTokenDiscount);
                document.getElementById('totalAmount').textContent = 'NT$ ' + finalAmount.toLocaleString();

                // é¡¯ç¤º/éš±è—ä»£å¹£æŠ˜æŠµè¡Œ
                const discountRow = document.getElementById('tokenDiscountRow');
                if (currentTokenDiscount > 0) {
                    discountRow.style.display = 'flex';
                    document.getElementById('tokenDiscount').textContent = '- NT$ ' + currentTokenDiscount.toLocaleString();
                } else {
                    discountRow.style.display = 'none';
                }
            }

            // ä¸€éµä½¿ç”¨ä»£å¹£
            document.getElementById('btnUseTokens').addEventListener('click', function () {
                // æ™ºèƒ½è¨ˆç®—æ‡‰ä½¿ç”¨çš„ä»£å¹£æ•¸é‡
                let tokenToUse = 0;
                const messageEl = document.getElementById('tokenMessage');

                if (availableTokens >= orderSubtotal) {
                    // æƒ…æ³1: ä»£å¹£ >= è¨‚å–®é‡‘é¡ â†’ åªæŠ˜æŠµè¨‚å–®é‡‘é¡
                    tokenToUse = orderSubtotal;
                    messageEl.innerHTML = `<i class="fas fa-check-circle text-success"></i> å·²ä½¿ç”¨ ${tokenToUse} å…ƒä»£å¹£ï¼Œå‰©é¤˜ ${availableTokens - tokenToUse} å…ƒ`;
                    messageEl.className = 'mt-2 small text-success';
                } else {
                    // æƒ…æ³2: ä»£å¹£ < è¨‚å–®é‡‘é¡ â†’ å…¨éƒ¨ç”¨å®Œ
                    tokenToUse = availableTokens;
                    messageEl.innerHTML = `<i class="fas fa-check-circle text-success"></i> å·²ä½¿ç”¨å…¨éƒ¨ ${tokenToUse} å…ƒä»£å¹£ï¼Œé‚„éœ€æ”¯ä»˜ ${orderSubtotal - tokenToUse} å…ƒ`;
                    messageEl.className = 'mt-2 small text-success';
                }

                // æ›´æ–°è¼¸å…¥æ¡†å’ŒæŠ˜æŠµé‡‘é¡
                document.getElementById('tokenAmount').value = tokenToUse;
                currentTokenDiscount = tokenToUse;
                calculateTotal();
            });

            // æ‰‹å‹•è¼¸å…¥ä»£å¹£æ•¸é‡
            document.getElementById('tokenAmount').addEventListener('input', function () {
                let inputValue = parseInt(this.value) || 0;
                const messageEl = document.getElementById('tokenMessage');

                // é©—è­‰è¼¸å…¥
                if (inputValue < 0) {
                    inputValue = 0;
                    this.value = 0;
                }

                if (inputValue > availableTokens) {
                    inputValue = availableTokens;
                    this.value = availableTokens;
                    messageEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> è¶…éå¯ç”¨ä»£å¹£ï¼Œå·²è‡ªå‹•èª¿æ•´ç‚º ${availableTokens} å…ƒ`;
                    messageEl.className = 'mt-2 small text-warning';
                } else if (inputValue > orderSubtotal) {
                    inputValue = orderSubtotal;
                    this.value = orderSubtotal;
                    messageEl.innerHTML = `<i class="fas fa-info-circle"></i> è¶…éè¨‚å–®é‡‘é¡ï¼Œå·²è‡ªå‹•èª¿æ•´ç‚º ${orderSubtotal} å…ƒ`;
                    messageEl.className = 'mt-2 small text-info';
                } else if (inputValue > 0) {
                    const remaining = availableTokens - inputValue;
                    const toPay = orderSubtotal - inputValue;
                    messageEl.innerHTML = `<i class="fas fa-check-circle"></i> ä½¿ç”¨ ${inputValue} å…ƒä»£å¹£ï¼Œå‰©é¤˜ ${remaining} å…ƒï¼Œé‚„éœ€æ”¯ä»˜ ${toPay} å…ƒ`;
                    messageEl.className = 'mt-2 small text-success';
                } else {
                    messageEl.innerHTML = '';
                }

                currentTokenDiscount = inputValue;
                calculateTotal();
            });

            // æäº¤è¨‚å–®
            document.getElementById('btnSubmitOrder').addEventListener('click', function () {
                const form = document.getElementById('orderForm');
                const agreeTerms = document.getElementById('agreeTerms');

                // é©—è­‰è¡¨å–®
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                if (!agreeTerms.checked) {
                    alert('è«‹å…ˆåŒæ„æœå‹™æ¢æ¬¾');
                    return;
                }

                // æ”¶é›†è¨‚å–®è³‡æ–™
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

                const orderData = {
                    tickets: selections,
                    buyerName: form.buyerName.value,
                    buyerPhone: form.buyerPhone.value,
                    buyerEmail: form.buyerEmail.value,
                    paymentMethod: paymentMethod,
                    tokenDiscount: currentTokenDiscount,
                    totalAmount: orderSubtotal - currentTokenDiscount
                };

                // fetch('/api/orders/create', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(orderData)
                // })
                // .then(response => response.json())
                // .then(data => {
                //     // å°å‘ä»˜æ¬¾é é¢æˆ–æˆåŠŸé é¢
                //     window.location.href = '/order/success?id=' + data.orderId;
                // });
            });
        });
    </script>
</body>

</html>