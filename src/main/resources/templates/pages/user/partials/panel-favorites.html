<h3 class="mb-4">我的收藏</h3>

<ul class="nav nav-pills mb-4">
    <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="pill" href="#fav-events">活動 (<span id="fav-events-count"
                th:text="${favoriteEvents != null ? favoriteEvents.size() : 0}">0</span>)</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#fav-products">商品 (1)</a>
    </li>
</ul>

<div class="tab-content">
    <!-- Events Tab -->
    <div class="tab-pane fade show active" id="fav-events">
        <div class="row g-4" id="favoritesList" th:if="${favoriteEvents != null and !favoriteEvents.isEmpty()}">
            <div class="col-md-6 col-xl-4" th:each="event : ${favoriteEvents}">
                <div class="card bg-dark border-secondary h-100">
                    <div class="row g-0 h-100">
                        <div class="col-4 position-relative">
                            <a th:href="@{/event/{id}(id=${event.eventId})}">
                                <img loading="lazy" th:src="${event.coverImageUrl}"
                                    class="img-fluid rounded-start h-100" style="object-fit: cover;">
                            </a>
                        </div>
                        <div class="col-8">
                            <div class="card-body d-flex flex-column h-100">
                                <h6 class="card-title text-white mb-1">
                                    <a th:href="@{/event/{id}(id=${event.eventId})}"
                                        class="text-white text-decoration-none text-truncate d-block"
                                        th:text="${event.title}">活動標題</a>
                                </h6>
                                <p class="card-text text-muted small mb-2"><i class="far fa-calendar-alt me-1"></i>
                                    <span th:text="${#temporals.format(event.eventStartAt, 'MM/dd HH:mm')}">12/31
                                        19:30</span>
                                </p>
                                <p class="card-text text-warning fw-bold mb-auto">
                                    NT$ <span
                                        th:text="${event.minPrice != null ? #numbers.formatInteger(event.minPrice, 0, 'COMMA') : '0'}">1,880</span>
                                    起
                                </p>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <a th:href="@{/event/{id}(id=${event.eventId})}"
                                        class="btn btn-sm btn-primary">立即購票</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- No Data Placeholder -->
        <div class="text-center py-5 text-muted" id="noFavoritesMsg"
            th:classappend="${favoriteEvents != null and !favoriteEvents.isEmpty()} ? 'd-none' : ''">
            <i class="fas fa-heart fa-3x mb-3 opacity-25"></i>
            <p>目前還沒有收藏任何活動喔！</p>
            <a th:href="@{/event/list}" class="btn btn-outline-primary btn-sm mt-2">去探索活動</a>
        </div>
    </div>

    <script th:inline="javascript">
        $(document).off('click', '.btn-remove-favorite').on('click', '.btn-remove-favorite', function () {
            const $btn = $(this);
            const eventId = $btn.data('event-id');
            const $card = $btn.closest('.col-md-6');

            if ($btn.hasClass('processing')) return;

            if (confirm('確定要取消收藏此活動嗎？')) {
                $btn.addClass('processing').prop('disabled', true);
                const originalHtml = $btn.html();
                $btn.html('<i class="fas fa-spinner fa-spin"></i>');

                $.ajax({
                    url: '/api/event/favorite/' + eventId,
                    type: 'POST',
                    success: function (response) {
                        if (response.success && response.isFavorited === false) {
                            $card.fadeOut(300, function () {
                                $card.remove();
                                const currentCount = $('#favoritesList .col-md-6').length;
                                $('#fav-events-count').text(currentCount);
                                $('.favorite-count-sidebar').text(currentCount);

                                if (currentCount === 0) {
                                    $('#noFavoritesMsg').removeClass('d-none');
                                }
                            });
                        } else {
                            // 如果後端傳回的是 true，表示又被加回去了，或是操作不符預期
                            $btn.removeClass('processing').prop('disabled', false).html(originalHtml);
                            if (response.isFavorited === true) {
                                alert('取消收藏失敗，請避免重複點擊');
                            }
                        }
                    },
                    error: function () {
                        $btn.removeClass('processing').prop('disabled', false).html(originalHtml);
                        alert('操作失敗，請稍後再試');
                    }
                });
            }
        });

        function renderPagination(pageData) {
            const nav = $('nav.mt-5');
            if (pageData.totalPages <= 1) { nav.hide(); return; }
            nav.show();
            // Standard pagination logic
        }
    </script>

    <!-- Products Tab -->
    <div class="tab-pane fade" id="fav-products">
        <div class="row g-4">
            <div class="col-md-6 col-xl-4">
                <div class="card bg-dark border-secondary h-100">
                    <div class="row g-0 h-100">
                        <div class="col-4 position-relative">
                            <img loading="lazy" src="https://via.placeholder.com/300x400"
                                class="img-fluid rounded-start h-100" style="object-fit: cover;">
                            <div class="position-absolute top-0 start-0 m-2">
                                <span class="badge bg-danger">限時特價</span>
                            </div>
                        </div>
                        <div class="col-8">
                            <div class="card-body d-flex flex-column h-100">
                                <h6 class="card-title text-white mb-1">官方應援手燈</h6>
                                <p class="card-text text-muted small mb-2">明星周邊 / 配件</p>
                                <div>
                                    <span class="text-danger fw-bold me-2">NT$ 899</span>
                                    <small class="text-decoration-line-through text-muted">NT$
                                        1,200</small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-auto">
                                    <button class="btn btn-sm btn-primary"><i class="fas fa-cart-plus"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>